@model PharmaPlus.Controllers.DbTestViewModel
@{
    ViewBag.Title = "Kết Quả Kiểm Tra Cơ Sở Dữ Liệu";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Kết Quả Kiểm Tra Cơ Sở Dữ Liệu</h2>

<div class="alert @(Model.EfTestResult.IsSuccessful && Model.DirectTestResult.IsSuccessful ? "alert-success" : "alert-danger")">
    <h4>
        <i class="glyphicon @(Model.EfTestResult.IsSuccessful && Model.DirectTestResult.IsSuccessful ? "glyphicon-ok" : "glyphicon-warning-sign")"></i>
        Tổng quan:
    </h4>
    @if (Model.EfTestResult.IsSuccessful && Model.DirectTestResult.IsSuccessful)
    {
        <p><strong>Tất cả các kiểm tra đã thành công! Kết nối cơ sở dữ liệu hoạt động bình thường.</strong></p>
    }
    else
    {
        <p><strong>Phát hiện vấn đề! Xem chi tiết bên dưới để biết thêm thông tin.</strong></p>
    }
</div>

<div class="row">
    <div class="col-md-6">
        <!-- Entity Framework Test -->
        <div class="panel @(Model.EfTestResult.IsSuccessful ? "panel-success" : "panel-danger")">
            <div class="panel-heading">
                <h3 class="panel-title">Kiểm tra Entity Framework</h3>
            </div>
            <div class="panel-body">
                @if (Model.EfTestResult.IsSuccessful)
                {
                    <h4><i class="glyphicon glyphicon-ok-circle"></i> Kết nối thành công</h4>

                    if (Model.EfTestResult.TableResults.Count > 0)
                    {
                        <h5>Thông tin bảng:</h5>
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Tên bảng</th>
                                    <th>Số bản ghi</th>
                                    <th>Có dữ liệu</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var table in Model.EfTestResult.TableResults)
                                {
                                    <tr>
                                        <td>@table.Key</td>
                                        <td>@table.Value.Count</td>
                                        <td>
                                            @if (table.Value.HasData)
                                            {
                                                <span class="text-success"><i class="glyphicon glyphicon-ok"></i> Có</span>
                                            }
                                            else
                                            {
                                                <span class="text-warning"><i class="glyphicon glyphicon-remove"></i> Không</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                    if (Model.EfTestResult.Warnings.Count > 0)
                    {
                        <div class="alert alert-warning">
                            <h5>Cảnh báo:</h5>
                            <ul>
                                @foreach (var warning in Model.EfTestResult.Warnings)
                                {
                                    <li>@warning</li>
                                }
                            </ul>
                        </div>
                    }
                }
                else
                {
                    <h4><i class="glyphicon glyphicon-remove-circle"></i> Kết nối thất bại</h4>
                    <div class="alert alert-danger">
                        <p><strong>Lỗi:</strong> @Model.EfTestResult.Error</p>
                        @if (!string.IsNullOrEmpty(Model.EfTestResult.InnerError))
                        {
                            <p><strong>Chi tiết:</strong> @Model.EfTestResult.InnerError</p>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <!-- Direct Connection Test -->
        <div class="panel @(Model.DirectTestResult.IsSuccessful ? "panel-success" : "panel-danger")">
            <div class="panel-heading">
                <h3 class="panel-title">Kiểm tra kết nối trực tiếp</h3>
            </div>
            <div class="panel-body">
                @if (Model.DirectTestResult.IsSuccessful)
                {
                    <h4><i class="glyphicon glyphicon-ok-circle"></i> Kết nối thành công</h4>
                    <dl class="dl-horizontal">
                        <dt>Cơ sở dữ liệu:</dt>
                        <dd>@Model.DirectTestResult.DatabaseName</dd>
                        <dt>Phiên bản SQL Server:</dt>
                        <dd>@(Model.DirectTestResult.ServerVersion?.Length > 60 ? Model.DirectTestResult.ServerVersion.Substring(0, 60) + "..." : Model.DirectTestResult.ServerVersion)</dd>
                    </dl>

                    if (Model.DirectTestResult.DbSchemaInfo.Count > 0)
                    {
                        <h5>Cấu trúc cơ sở dữ liệu:</h5>
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Bảng</th>
                                    <th>Số cột</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var table in Model.DirectTestResult.DbSchemaInfo)
                                {
                                    <tr>
                                        <td>@table.Key</td>
                                        <td>@table.Value</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                }
                else
                {
                    <h4><i class="glyphicon glyphicon-remove-circle"></i> Kết nối thất bại</h4>
                    <div class="alert alert-danger">
                        <p><strong>Lỗi:</strong> @Model.DirectTestResult.Error</p>
                        @if (!string.IsNullOrEmpty(Model.DirectTestResult.InnerError))
                        {
                            <p><strong>Chi tiết:</strong> @Model.DirectTestResult.InnerError</p>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <!-- Connection String Analysis -->
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">Phân tích chuỗi kết nối</h3>
            </div>
            <div class="panel-body">
                @if (Model.ConnectionStringResults.Count > 0)
                {
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Tên</th>
                                <th>Trạng thái</th>
                                <th>Máy chủ</th>
                                <th>Cơ sở dữ liệu</th>
                                <th>Bảo mật</th>
                                <th>Chi tiết</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cs in Model.ConnectionStringResults)
                            {
                                <tr class="@(cs.IsValid ? "success" : "danger")">
                                    <td><strong>@cs.Name</strong></td>
                                    <td>
                                        @if (cs.IsValid)
                                        {
                                            <span class="label label-success">Hợp lệ</span>
                                        }
                                        else
                                        {
                                            <span class="label label-danger">Không hợp lệ</span>
                                        }
                                    </td>
                                    <td>@cs.DataSource</td>
                                    <td>@cs.InitialCatalog</td>
                                    <td>
                                        @if (cs.IntegratedSecurity)
                                        {
                                            <span>Windows Authentication</span>
                                        }
                                        else if (!string.IsNullOrEmpty(cs.UserID))
                                        {
                                            <span>SQL Authentication (@cs.UserID)</span>
                                        }
                                        else
                                        {
                                            <span>Không xác định</span>
                                        }
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-info btn-xs" data-toggle="modal" data-target="#cs-@cs.Name.Replace(".", "-")">
                                            Chi tiết
                                        </button>
                                        
                                        <!-- Modal for connection string details -->
                                        <div class="modal fade" id="cs-@cs.Name.Replace(".", "-")" tabindex="-1" role="dialog" aria-labelledby="csModalLabel">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                        <h4 class="modal-title" id="csModalLabel">Chi tiết chuỗi kết nối: @cs.Name</h4>
                                                    </div>
                                                    <div class="modal-body">
                                                        <dl class="dl-horizontal">
                                                            <dt>Tên:</dt>
                                                            <dd>@cs.Name</dd>
                                                            <dt>Provider:</dt>
                                                            <dd>@cs.ProviderName</dd>
                                                            <dt>Chuỗi kết nối:</dt>
                                                            <dd><code>@cs.ConnectionString</code></dd>
                                                            <dt>Máy chủ:</dt>
                                                            <dd>@cs.DataSource</dd>
                                                            <dt>Cơ sở dữ liệu:</dt>
                                                            <dd>@cs.InitialCatalog</dd>
                                                            <dt>Integrated Security:</dt>
                                                            <dd>@cs.IntegratedSecurity</dd>
                                                            <dt>User ID:</dt>
                                                            <dd>@cs.UserID</dd>
                                                            <dt>Trạng thái:</dt>
                                                            <dd>
                                                                @if (cs.IsValid)
                                                                {
                                                                    <span class="label label-success">Hợp lệ</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="label label-danger">Không hợp lệ</span>
                                                                    <p class="text-danger">@cs.Error</p>
                                                                }
                                                            </dd>
                                                        </dl>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="alert alert-warning">
                        <p>Không tìm thấy chuỗi kết nối nào!</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div>
    @Html.ActionLink("Quay lại", "Index", null, new { @class = "btn btn-primary" })
    @Html.ActionLink("Trang chủ", "Index", "Home", null, new { @class = "btn btn-default" })
</div>