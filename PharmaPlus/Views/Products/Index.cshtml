@model PharmaPlus.Models.ProductListViewModel
@{
    ViewBag.Title = "Danh sách sản phẩm - PharmaPlus";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Chỉ giữ nội dung, bỏ các thẻ html, head, body -->
<!-- Modern Hero Section -->
<section class="products-hero">
    <div class="products-container">
        <div class="products-hero-content">
            <h1 class="products-hero-title">
                Khám phá <span class="highlight">sản phẩm</span><br>
                chất lượng cao
            </h1>
            <p class="products-hero-description">
                Bộ sưu tập đa dạng thuốc và thiết bị y tế từ các thương hiệu uy tín hàng đầu thế giới
            </p>
            <div class="products-stats-container">
                <div class="products-stat-card">
                    <i class="fas fa-pills products-stat-icon"></i>
                    <span class="products-stat-number">@Model.TotalProducts</span>
                    <span class="products-stat-label">Sản phẩm</span>
                </div>
                <div class="products-stat-card">
                    <i class="fas fa-layer-group products-stat-icon"></i>
                    <span class="products-stat-number">@Model.Categories.Count</span>
                    <span class="products-stat-label">Danh mục</span>
                </div>
                <div class="products-stat-card">
                    <i class="fas fa-award products-stat-icon"></i>
                    <span class="products-stat-number">100%</span>
                    <span class="products-stat-label">Chính hãng</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modern Search & Filter Section -->
<section class="products-search-section">
    <div class="products-container">
        <div class="products-search-header">
            <h2 class="products-search-title">Tìm kiếm sản phẩm</h2>
            <p class="products-search-subtitle">
                Sử dụng bộ lọc thông minh để tìm sản phẩm phù hợp với nhu cầu của bạn
            </p>
        </div>

        <!-- Search Bar -->
        <div class="products-search-container">
            <div class="products-search-wrapper">
                <i class="fas fa-search products-search-icon"></i>
                <input type="text" 
                       id="productsSearchInput" 
                       class="products-search-input"
                       placeholder="Nhập tên sản phẩm, thành phần, hoặc từ khóa..." 
                       value="@Model.CurrentSearch" />
                <button type="button" class="products-search-btn" onclick="performSearch()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- Filters Grid -->
        <div class="products-filters-container">
            <div class="products-filter-card">
                <label class="products-filter-label">
                    <i class="fas fa-layer-group"></i>
                    Danh mục sản phẩm
                </label>
                <select id="productsCategoryFilter" class="products-filter-select" onchange="filterProducts()">
                    <option value="">Tất cả danh mục</option>
                    @foreach (var category in Model.Categories)
                    {
                        <option value="@category.name" @(Model.CurrentCategory == category.name ? "selected" : "")>
                            @category.name
                        </option>
                    }
                </select>
            </div>

            <div class="products-filter-card">
                <label class="products-filter-label">
                    <i class="fas fa-sort-amount-down"></i>
                    Sắp xếp theo
                </label>
                <select id="productsSortFilter" class="products-filter-select" onchange="filterProducts()">
                    <option value="name" @(Model.SortBy == "name" ? "selected" : "")>Tên A-Z</option>
                    <option value="name_desc" @(Model.SortBy == "name_desc" ? "selected" : "")>Tên Z-A</option>
                    <option value="price_asc" @(Model.SortBy == "price_asc" ? "selected" : "")>Giá thấp → cao</option>
                    <option value="price_desc" @(Model.SortBy == "price_desc" ? "selected" : "")>Giá cao → thấp</option>
                    <option value="newest" @(Model.SortBy == "newest" ? "selected" : "")>Mới nhất</option>
                    <option value="popular" @(Model.SortBy == "popular" ? "selected" : "")>Phổ biến nhất</option>
                </select>
            </div>

            <div class="products-filter-card">
                <label class="products-filter-label">
                    <i class="fas fa-filter"></i>
                    Thao tác nhanh
                </label>
                <button class="products-clear-btn" onclick="clearAllFilters()">
                    <i class="fas fa-times"></i>
                    Xóa tất cả bộ lọc
                </button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="products-toolbar">
            <div class="products-results-info">
                <span>
                    Hiển thị <strong>@((Model.CurrentPage - 1) * Model.PageSize + 1) - @Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalProducts)</strong> 
                    trong tổng số <strong>@Model.TotalProducts</strong> sản phẩm
                    @if (!string.IsNullOrEmpty(Model.CurrentSearch))
                    {
                        <span> cho từ khóa "<strong>@Model.CurrentSearch</strong>"</span>
                    }
                </span>
            </div>
            <div class="products-view-controls">
                <div class="products-view-toggle">
                    <button class="products-view-btn active" data-view="grid" title="Xem dạng lưới">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="products-view-btn" data-view="list" title="Xem dạng danh sách">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Products Grid Section -->
<section class="products-section">
    <div class="products-container">
        @if (Model.Products.Any())
        {
            <div class="products-grid" id="productsGrid">
                @foreach (var product in Model.Products)
                {
                    <article class="products-card" data-product-id="@product.id">
                        <div class="products-image-container">
                            <img src="@product.DisplayImageUrl" 
                                 alt="@product.name" 
                                 class="products-image"
                                 loading="lazy" 
                                 onerror="handleImageError(this)" />
                            
                            <div class="products-overlay">
                                <div class="products-actions">
                                    <button class="products-action-btn" 
                                            data-product-id="@product.id"
                                            onclick="quickView(@product.id)" 
                                            title="Xem chi tiết">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    
                                    <button class="products-action-btn" 
                                            data-product-id="@product.id"
                                            onclick="addToCartFromProducts(@product.id)" 
                                            title="Thêm vào giỏ hàng">
                                        <i class="fas fa-shopping-cart"></i>
                                    </button>
                                </div>
                            </div>

                            @if (product.StockStatus == "low-stock")
                            {
                                <div class="products-badge products-badge-low-stock">Sắp hết</div>
                            }
                            else if (product.StockStatus == "out-of-stock")
                            {
                                <div class="products-badge products-badge-out-of-stock">Hết hàng</div>
                            }
                            else if (product.IsNew)
                            {
                                <div class="products-badge products-badge-new">Mới</div>
                            }
                        </div>
                        
                        <div class="products-content">
                            <div class="products-category">
                                @{
                                    string categoryName = "Khác";
                                    if (product.Category != null && !string.IsNullOrEmpty(product.Category.name))
                                    {
                                        categoryName = product.Category.name;
                                    }
                                }
                                @categoryName
                            </div>
                            
                            <h3 class="products-title">
                                <a href="@Url.Action("Details", new { id = product.id })">@product.name</a>
                            </h3>
                            
                            <p class="products-description">
                                @{
                                    string description = "Chưa có mô tả chi tiết cho sản phẩm này.";
                                    if (!string.IsNullOrEmpty(product.description))
                                    {
                                        description = product.description.Length > 120 ? 
                                                     product.description.Substring(0, 120) + "..." : 
                                                     product.description;
                                    }
                                }
                                @Html.Raw(description)
                            </p>
                            
                            <div class="products-rating">
                                <div class="products-stars">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <i class="fas fa-star @(i <= 4 ? "" : "")"></i>
                                    }
                                </div>
                                <span class="products-rating-text">(4.5)</span>
                            </div>
                            
                            <div class="products-footer">
                                <div class="products-price">
                                    @product.price.ToString("N0") VNĐ
                                </div>
                                <div class="products-stock @product.StockStatus">
                                    <i class="fas fa-box"></i>
                                    <span>
                                        @if (product.stock == 0)
                                        {
                                            @("Hết hàng")
                                        }
                                        else if (product.stock <= 5)
                                        {
                                            @("Còn " + product.stock)
                                        }
                                        else
                                        {
                                            @("Còn hàng")
                                        }
                                    </span>
                                </div>
                            </div>
                            
                            <div class="products-btn-container">
                                <button class="products-btn-add-cart" 
                                        data-product-id="@product.id"
                                        onclick="addToCartFromProducts(@product.id)" 
                                        @(product.stock == 0 ? "disabled" : "")>
                                    <i class="fas fa-@(product.stock == 0 ? "ban" : "cart-plus")"></i>
                                    @(product.stock == 0 ? "Hết hàng" : "Thêm vào giỏ")
                                </button>
                            </div>
                        </div>
                    </article>
                }
            </div>
        }
        else
        {
            <div class="products-empty-state">
                <div class="products-empty-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h3 class="products-empty-title">Không tìm thấy sản phẩm</h3>
                <p class="products-empty-description">
                    Không có sản phẩm nào phù hợp với tiêu chí tìm kiếm của bạn. 
                    Hãy thử thay đổi từ khóa hoặc bộ lọc.
                </p>
                <button class="products-clear-btn" onclick="clearAllFilters()">
                    <i class="fas fa-refresh"></i>
                    Xóa tất cả bộ lọc
                </button>
            </div>
        }

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="products-pagination-container">
                <nav class="products-pagination">
                    @if (Model.CurrentPage > 1)
                    {
                        <a href="@Url.Action("Index", new { page = Model.CurrentPage - 1, category = Model.CurrentCategory, search = Model.CurrentSearch, sortBy = Model.SortBy })" 
                           class="products-page-btn">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    }

                    @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                    {
                        <a href="@Url.Action("Index", new { page = i, category = Model.CurrentCategory, search = Model.CurrentSearch, sortBy = Model.SortBy })" 
                           class="products-page-btn @(i == Model.CurrentPage ? "active" : "")">
                            @i
                        </a>
                    }

                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <a href="@Url.Action("Index", new { page = Model.CurrentPage + 1, category = Model.CurrentCategory, search = Model.CurrentSearch, sortBy = Model.SortBy })" 
                           class="products-page-btn">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    }
                </nav>
            </div>
        }
    </div>
</section>

<!-- Cập nhật modal cart trong _Layout.cshtml -->
<div id="cartModal" class="cart-modal">
    <div class="cart-modal-content" style="display: flex; flex-direction: column; overflow: hidden;">
        <div class="cart-modal-header" style="flex: 0 0 auto;">
            <h3><i class="fas fa-shopping-cart"></i> Giỏ hàng của bạn</h3>
            <button class="cart-modal-close" onclick="closeCartModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="cart-modal-body" id="cartModalBody" style="flex: 1 1 auto; overflow-y: auto; max-height: none;">
            <!-- Cart items will be loaded here -->
        </div>
        
        <div class="cart-modal-footer" id="cartModalFooter" style="flex: 0 0 auto;">
            <div class="cart-modal-total">
                <div class="cart-summary">
                    <div class="summary-item">
                        <span>Tổng sản phẩm:</span>
                        <span id="modalTotalItems">0</span>
                    </div>
                    <div class="summary-item total-amount">
                        <span>Tổng cộng:</span>
                        <span id="modalTotalAmount">0 VNĐ</span>
                    </div>
                </div>
            </div>
            <div class="cart-modal-actions">
                <button class="btn btn-outline" onclick="clearAllCart()">
                    <i class="fas fa-trash"></i> Xóa giỏ hàng
                </button>
                <button class="btn btn-primary" onclick="proceedToCheckout()">
                    <i class="fas fa-check"></i> Thanh toán
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <!-- Các script đặc thù cho trang Products -->
    <script src="~/Scripts/js/products-script.js"></script>
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Page-specific initialization
        });
    </script>
}