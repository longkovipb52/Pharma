<header class="header">
    <div class="container">
        <a href="@Url.Action("Index", "Home")" class="nav-brand">
            <i class="fas fa-pills"></i>
            <span>PharmaPlus</span>
        </a>

        <nav class="nav-menu" id="navMenu">
            <a href="@Url.Action("Index", "Home")" class="nav-link @(ViewContext.RouteData.Values["Controller"].ToString() == "Home" && ViewContext.RouteData.Values["Action"].ToString() == "Index" ? "active" : "")" data-page="home">Trang chủ</a>
            <a href="@Url.Action("Index", "Products")" class="nav-link @(ViewContext.RouteData.Values["Controller"].ToString() == "Products" ? "active" : "")" data-page="products">Sản phẩm</a>
            <a href="@Url.Action("History", "Review")" class="nav-link @(ViewContext.RouteData.Values["Controller"].ToString() == "Review" ? "active" : "")" data-page="reviews">Đánh giá</a>
            <a href="@Url.Action("Index", "About")" class="nav-link @(ViewContext.RouteData.Values["Controller"].ToString() == "About" ? "active" : "")" data-page="about">Giới thiệu</a>
            <a href="@Url.Action("Index", "Contact")" class="nav-link @(ViewContext.RouteData.Values["Controller"].ToString() == "Contact" ? "active" : "")" data-page="contact">Liên hệ</a>
        </nav>

        <div class="nav-actions">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Tìm kiếm sản phẩm..." id="searchInput">
                <i class="fas fa-search search-icon"></i>
            </div>

            @if (Session["Username"] != null)
            {
                <div class="user-menu">
                    <button class="user-btn" id="userMenuBtn">
                        <i class="fas fa-user"></i>
                        <span>@Session["Username"]</span>
                        <i class="fas fa-chevron-down" style="font-size: 10px; margin-left: 2px;"></i>
                    </button>
                    <!-- Đoạn code trong dropdown menu người dùng -->
                    <div class="user-dropdown" id="userDropdown">
                        <a href="@Url.Action("Index", "Profile")">
                            <i class="fas fa-user"></i> 
                            Hồ sơ cá nhân
                        </a>
                        <a href="@Url.Action("Index", "OrderHistory")" class="order-history-link">
                            <i class="fas fa-shopping-bag"></i> 
                            Đơn hàng của tôi
                        </a>
                        <a href="@Url.Action("Logout", "Account")">
                            <i class="fas fa-sign-out-alt"></i> 
                            Đăng xuất
                        </a>
                    </div>
                </div>
            }
            else
            {
                <a href="@Url.Action("Login", "Account")" class="btn btn-outline btn-sm" style="display: flex;">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Đăng nhập</span>
                </a>
            }

            <button class="icon-btn" id="cartBtn" title="Giỏ hàng">
                <i class="fas fa-shopping-cart"></i>
                <span class="badge" style="display: none;">0</span>
            </button>
            
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>
</header>

<!-- 🔥 SCRIPT ĐƠN GIẢN VÀ TẬP TRUNG -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Header script initialized');
    
    // === USER MENU DROPDOWN ===
    const userMenuBtn = document.getElementById('userMenuBtn');
    const userDropdown = document.getElementById('userDropdown');
    
    if (userMenuBtn && userDropdown) {
        console.log('✅ User menu found');
        
        userMenuBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('🔄 User menu clicked');
            
            // Toggle dropdown
            userDropdown.classList.toggle('show');
        });
        
        // Close when clicking outside
        document.addEventListener('click', function(e) {
            if (userDropdown.classList.contains('show') && 
                !userMenuBtn.contains(e.target) && 
                !userDropdown.contains(e.target)) {
                userDropdown.classList.remove('show');
            }
        });
    }
    
    // === MOBILE MENU ===
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const navMenu = document.getElementById('navMenu');
    
    if (mobileMenuBtn && navMenu) {
        mobileMenuBtn.addEventListener('click', function() {
            navMenu.classList.toggle('active');
            
            const icon = this.querySelector('i');
            if (navMenu.classList.contains('active')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });
    }
    
    // === SEARCH FUNCTIONALITY ===
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.trim();
                if (searchTerm.length >= 2) {
                    const searchUrl = '@Url.Action("Index", "Products")' + '?search=' + encodeURIComponent(searchTerm);
                    window.location.href = searchUrl;
                }
            }
        });
    }
    
    // === CART BUTTON ===
    const cartBtn = document.getElementById('cartBtn');
    if (cartBtn) {
        cartBtn.addEventListener('click', function() {
            if (typeof window.openCartModal === 'function') {
                window.openCartModal();
            } else {
                console.warn('Cart modal not available yet');
                // Fallback if openCartModal isn't available yet
                window.location.href = '@Url.Action("Index", "Cart")';
            }
        });
    }
    
    // === HEADER SCROLL EFFECT ===
    const header = document.querySelector('.header');
    
    function updateHeaderStyle() {
        if (window.scrollY > 50) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    }
    
    // Run once on page load
    updateHeaderStyle();
    
    // Set up scroll listener
    window.addEventListener('scroll', updateHeaderStyle);
    
    // Đảm bảo liên kết "Đơn hàng của tôi" hoạt động đúng
    const orderHistoryLink = document.querySelector('.order-history-link');
    if (orderHistoryLink) {
        orderHistoryLink.addEventListener('click', function(e) {
            // Kiểm tra xem người dùng đã đăng nhập chưa
            const isLoggedIn = '@(Session["Username"] != null)' === 'True';
            
            if (!isLoggedIn) {
                e.preventDefault();
                // Chuyển hướng đến trang đăng nhập với returnUrl
                window.location.href = '@Url.Action("Login", "Account")?returnUrl=' + 
                    encodeURIComponent('@Url.Action("Index", "OrderHistory")');
            }
            // Nếu đã đăng nhập, liên kết sẽ hoạt động bình thường
        });
    }
});
</script>